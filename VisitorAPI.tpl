___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "VisitorAPI",
  "categories": ["UTILITY"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Retrieve website visitor IP, location, currencies, languages, and device information.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "projectId",
    "displayName": "Project ID",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const queryPermission = require('queryPermission');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const createQueue = require('createQueue');

const url = 'https://cdn.visitorapi.com/visitor-api.js';
const onSuccess = function(data){
  const dataLayerPush = createQueue('dataLayer');
  dataLayerPush({
    event: 'visitor-api-success',
    visitorApiIpAddress: data.ipAddress,
    visitorApiCountryCode: data.countryCode,
    visitorApiCountryName: data.countryName,
    visitorApiCurrencies: data.currencies,
    visitorApiLanguages: data.languages,
    visitorApiRegion: data.region,
    visitorApiCity: data.city,
    visitorApiCityLatLong: data.cityLatLong,
    visitorApiBrowser: data.browser,
    visitorApiBrowserVersion: data.browserVersion,
    visitorApiDeviceBrand: data.deviceBrand,
    visitorApiDeviceModel: data.deviceModel,
    visitorApiDeviceFamily: data.deviceFamily,
    visitorApiOs: data.os,
    visitorApiOsVersion: data.osVersion
  });
};
const onFailure = function(errorCode, errorMessage){
  const dataLayerPush = createQueue('dataLayer');
  dataLayerPush({
    event: 'visitor-api-error',
    visitorApiErrorCode: errorCode,
    visitorAPIErrorMessage: errorMessage
  });
};
if (queryPermission('inject_script', url)) {
  injectScript(url, function(){
    const api = copyFromWindow('VisitorAPI');
    if(typeof api !== 'undefined'){
      api(data.projectId, onSuccess, onFailure);
    }
  });
}

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "VisitorAPI"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.visitorapi.com/visitor-api.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test
  code: |-
    const mockData = {
      // Mocked field values
      projectId: 'cp7aHGexzLgytbJoyKTI'
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 06/05/2022, 9:13:40 pm


